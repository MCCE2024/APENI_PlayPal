name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Build, Test, Lint, and Publish Images"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., commit SHA or "latest")'
        required: true
        default: 'latest'

env:
  EXOSCALE_API_KEY: ${{ secrets.EXOSCALE_API_KEY }}
  EXOSCALE_API_SECRET: ${{ secrets.EXOSCALE_API_SECRET }}
  AWS_ACCESS_KEY_ID: ${{ secrets.EXOSCALE_API_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.EXOSCALE_API_SECRET }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run if manual trigger OR if upstream CI succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.x

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Fetch Kubeconfig
        working-directory: ./infra
        run: |
          mkdir -p $HOME/.kube
          terraform output -raw kubeconfig > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Determine Image Tag and Repo Owner
        id: context
        run: |
          # Set Repo Owner to lowercase
          echo "REPO_OWNER=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          
          # Determine Image Tag based on event type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Deploy frontend to Kubernetes
        run: |
          sed -i 's|YOUR_DOCKER_REGISTRY|ghcr.io/${{ env.REPO_OWNER }}|g' infra/k8s/frontend-deployment.yaml
          sed -i 's|:latest|:${{ env.IMAGE_TAG }}|g' infra/k8s/frontend-deployment.yaml
          kubectl apply -f infra/k8s/frontend-deployment.yaml
          kubectl apply -f infra/k8s/frontend-service.yaml

      - name: Deploy matching-service to Kubernetes
        run: |
          sed -i 's|YOUR_DOCKER_REGISTRY|ghcr.io/${{ env.REPO_OWNER }}|g' infra/k8s/matching-deployment.yaml
          sed -i 's|:latest|:${{ env.IMAGE_TAG }}|g' infra/k8s/matching-deployment.yaml
          kubectl apply -f infra/k8s/matching-deployment.yaml
          kubectl apply -f infra/k8s/matching-service.yaml

      - name: Deploy notification-service to Kubernetes
        run: |
          sed -i 's|YOUR_DOCKER_REGISTRY|ghcr.io/${{ env.REPO_OWNER }}|g' infra/k8s/notification-deployment.yaml
          sed -i 's|:latest|:${{ env.IMAGE_TAG }}|g' infra/k8s/notification-deployment.yaml
          kubectl apply -f infra/k8s/notification-deployment.yaml
          kubectl apply -f infra/k8s/notification-service.yaml